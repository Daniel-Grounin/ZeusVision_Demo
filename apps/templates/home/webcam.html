{% extends "layouts/base.html" %}

{% block title %}UI Icons{% endblock %}

{% block stylesheets %}
<style>
  .webcam-container {
    padding: 2px;
    margin-bottom: 10px;
  }
  .fixed-aspect-ratio {
    position: relative;
    width: 100%;
    height: 220px;
  }
  .fixed-aspect-ratio img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .row>[class^="col-"] {
    padding-right: 5px;
    padding-left: 5px;
  }
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    z-index: 1050;
    display: none;
    justify-content: center;
    align-items: center;
    text-align: center;
  }
  .overlay img {
    max-width: 80%;
    max-height: 80%;
  }
  .controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    flex-direction: column;
  }
  .controls button {
    margin: 5px;
  }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="content">
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-body all-icons">
          <div class="row">
            <div class="col-md-6 webcam-container">
              <div class="fixed-aspect-ratio">
                <img src="{% url 'first_webcam_feed' %}" onerror="this.onerror=null; this.src='{{ ASSETS_ROOT }}/img/camera_not_connected.jpg';" alt="First Webcam Feed" class="img-fluid">
              </div>
              <p>First Webcam</p>
              <button onclick="enlargeFeed('{% url 'first_webcam_feed' %}')" class="btn btn-primary">Enlarge Feed</button>
            </div>
            <div class="col-md-6 webcam-container">
              <div class="fixed-aspect-ratio">
                <img src="{% url 'second_webcam_feed' %}" onerror="this.onerror=null; this.src='{{ ASSETS_ROOT }}/img/camera_not_connected.jpg';" alt="Second Webcam Feed" class="img-fluid">
              </div>
              <p>Second Webcam</p>
              <button onclick="enlargeFeed('{% url 'second_webcam_feed' %}')" class="btn btn-primary">Enlarge Feed</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="videoOverlay" class="overlay">
  <img id="overlayFeed" src="" alt="Enlarged Feed">
  <div class="controls">
    <select id="modelSelect" onchange="updateFeeds()" class="btn btn-secondary">
      <option value="yolov8n.pt">YOLOv8n-COCO</option>
      <option value="best3.pt">Yolo-Tank</option>
      <option value="models/tankNZ.pt">tank</option>

    </select>
    <button onclick="zoomIn()" class="btn btn-primary">Zoom In</button>
    <button onclick="zoomOut()" class="btn btn-primary">Zoom Out</button>
    <button onclick="resetZoom()" class="btn btn-primary">Reset</button>
    <button onclick="rotate()" class="btn btn-primary">Rotate</button>
    <button onclick="closeOverlay()" class="btn btn-danger">Close</button>
  </div>
</div>



{% endblock content %}

{% block javascripts %}

<script>
  let scale = 1;
let rotation = 0;
let isDragging = false;
let startX, startY;
let currentX = 0;
let currentY = 0;

function updateFeeds() {
const model = document.getElementById('modelSelect').value;
const overlayFeed = document.getElementById('overlayFeed');
overlayFeed.src = `${overlayFeed.src.split('?')[0]}?model=${model}`;
updateTransform();  // Update the transform if necessary
}

function enlargeFeed(feedUrl) {
  const overlayFeed = document.getElementById('overlayFeed');
  overlayFeed.src = feedUrl;
  overlayFeed.style.transform = `scale(${scale}) rotate(${rotation}deg) translate(${currentX}px, ${currentY}px)`;
  document.getElementById('videoOverlay').style.display = 'flex';
}

function closeOverlay() {
  document.getElementById('videoOverlay').style.display = 'none';
  resetZoom();
}

function zoomIn() {
  scale += 0.1;
  updateTransform();
}

function zoomOut() {
  scale -= 0.1;
  updateTransform();
}

function resetZoom() {
  scale = 1;
  rotation = 0;
  currentX = 0;
  currentY = 0;
  updateTransform();
}

function rotate() {
  rotation = (rotation + 90) % 360;
  updateTransform();
}

function updateTransform() {
  const overlayFeed = document.getElementById('overlayFeed');
  overlayFeed.style.transform = `scale(${scale}) rotate(${rotation}deg) translate(${currentX}px, ${currentY}px)`;
}

document.getElementById('overlayFeed').addEventListener('mousedown', function(e) {
  isDragging = true;
  startX = e.clientX - currentX;
  startY = e.clientY - currentY;
  e.preventDefault();
});

document.addEventListener('mousemove', function(e) {
  if (isDragging) {
    const overlayFeed = document.getElementById('overlayFeed');
    currentX = e.clientX - startX;
    currentY = e.clientY - startY;
    updateTransform();
  }
});

document.addEventListener('mouseup', function() {
  isDragging = false;
});

</script>
{% endblock javascripts %}
